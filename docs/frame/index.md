---
title: monorepo
order: 1
toc: content
nav:
  title: frame
  order: 4
---

## 什么是 monorepo

_"mono" 来源于希腊语 μόνος 意味单个的，而 "repo"，显而易见地，是 repository 的缩写_

monorepo 是一种将多个项目代码存储在一个仓库里的软件开发策略

### 采用的解决方案

- 基于 lerna 和 yarn workspace 的 monorepo 工作流
- lerna 处理发布问题
- yarn 处理依赖问题

### 它有什么优势

#### 代码重用将变的非常容易

由于所有项目代码都集中于一个代码仓库，我们将很容易抽离出各个项目共用的业务组件或工具，并通过 Typescript，Lerna 或其他工具进行代码内引用

#### 依赖管理将变得非常简单

由于项目之间的引用路径内化在同一个仓库之中，我们很容易追踪当某个项目的代码修改后，会影响哪些项目。通过一些工具，我们很容易做到版本依赖管理和版本号自动升级

#### 代码重构将变得非常便捷

阻止我们进行代码重构的一个很重要的原因就是【不确定性】，不确定某个项目的修改是否对于其他而言是致命的，monorepo 策略可以明确知道代码的影响范围，并且能够过对被影响的项目进行统一的测试，鼓励不断优化代码
倡导开放、透明、共享的组织文化，有利于开发者成长、代码质量的提升
在 monorepo 策略下，每个开发者都被鼓励去查看，修改他人的代码(只要有必要)，同时也会激起开发者维护代码，编写单元测试的责任心，这将会形成一种良好的技术氛围，从而保障整个组织的代码质量

### 它有什么劣势

#### 项目粒度的权限管理变得非常复杂

无论是 Git、SNV 还是其他 VCS 系统，在支持 monorepo 策略中项目粒度的权限管理上都没有令人满意的解决方案，这意味着 A 部门在 a 项目若是不想被 B 部门的开发者看到就很难了。(当前 monorepo 策略仅限于项目级)

#### 新员工学习成本变高

不同于一个项目一个代码这种模式，在 monorepo 模式下，新人可能不得不花费更多精力来理清各个代码仓库之间的相互逻辑，虽然成本可以用文档的方式来解决，但是维护文档也需要额外的人力
对于公司级别的 monorepo 策略而言，需要专门的 VFS 系统，自动重构工具的支持
设想一下 Google 这样的企业是如何将十亿行的代码存储在一个仓库之中的？开发人员每次拉取代码需要等待多久？各个项目代码之间又如何实现权限管理，敏捷发布？任何简单的策略乘以足够的规模量级都会产生一个奇迹（不管是好是坏）

### 这样的项目里我们可以做什么

- 需求迭代开发(业务代码)
- 定制第三方依赖包
- 基于 Dumi 脚手架，项目文档站点搭建和维护
- shell 自动脚本(下面的文档站点，理想目标应该是做到自动文档更新)
- 新技术尝试(可以在子项目上试点，确立影响范围)
- 域名切换等提效页面开发
- 项目扩展
- 按需发版

### 为什么做文档建设

- 聚焦业务
- 丰富项目文档，不止于一个 readme，写你所想
- 利于搜索自己想要的内容
- 做其他常用链接的一个入口集合
- 有利于新人熟悉整体项目

### 我们获得了什么好处

#### 迁移成本的降低

几乎不需要修改原有代码，因为新的解决方案足够独立，可以做到不依赖老代码，不迁移老代码，不修改老代码

#### 更细的颗粒度、更多的扩展性

更细的拆分子项目，打包成第三方依赖包，并用 yarn link 做本地关联，提高代码的复用性和开发效率、项目也可以扩展 Dumi 等文档工具

#### 子项目之间绝对的独立

子项目之间业务拆分独立，项目最终的结果是所有子项目编译结果的集合，尽可能降低初始化包体积大小，提高用户初始进入页面的加载速度

#### 按需发版

打包上线可以以业务需求为纬度，进行需求发版

#### 框架迁移可以并行，不影响需求的正常迭代开发

#### 可以多个框架共存，为以后优化、重构、项目扩展提供更多的可能性解决方案

#### 子项目可以遵循单一原则，颗粒度更细(例如：单点登录)

#### 用户无感知迁移

#### 提高代码的复用性

#### 不限制技术栈

#### 开发环境页面与线上环境页面区分

- 用于开发环境提效的工具、页面等可以通过配置不会打包到线上环境

#### 有信心和动力进行代码深度优化

- 很容易确定修改代码的影响范围
- 始终维护的是一个仓库，产期维护更适合深度优化开发，提高代码质量(对比同时维护多个仓库)

## 参考网站

[All in one：项目级 monorepo 策略最佳实践](https://segmentfault.com/a/1190000039157365)
